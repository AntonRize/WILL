<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<div id="rom-engine-root" style="width: 100%; display: flex; justify-content: center; background: #000; min-height: 600px;">
    <div style="color: #444; font-family: monospace; align-self: center;">Loading R.O.M. Kernel v2.1...</div>
</div>

{% raw %}
<script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;

    // --- CONSTANTS ---
    const G = 6.67430e-11;
    const M_SUN = 1.989e30; 
    const C = 299792458; 

    const RomEngine = () => {
        // --- INPUTS (State) ---
        const [zInput, setZInput] = useState(0.5); 
        const [betaInput, setBetaInput] = useState(0.4);
        const [rpInput, setRpInput] = useState(1.5e11); // ~1 AU

        const canvasRef = useRef(null);

        // --- PHYSICS KERNEL ---
        const physics = useMemo(() => {
            // 1. Q_p (Total Relational Shift)
            const one_plus_z = 1 + zInput;
            const Q_p = Math.sqrt(1 - (1 / (one_plus_z * one_plus_z)));

            // Validity Check: Beta_p cannot exceed Q_p physically in this geometry
            let validState = true;
            if (betaInput > Q_p) validState = false;

            // 2. Kappa_p (Potential)
            let kappa_p = 0;
            if (validState) {
                // kappa = sqrt(Q^2 - beta^2)
                kappa_p = Math.sqrt(Math.max(0, Q_p**2 - betaInput**2));
            }

            // 3. Eccentricity (e)
            // Golden Ratio Logic: Circle when kappa = beta * sqrt(2)
            // e = | (2*beta^2 / kappa^2) - 1 |
            let e = 0;
            let isOpen = false;

            if (validState && kappa_p > 0.0001) {
                const ratio = (2 * betaInput**2) / (kappa_p**2);
                e = Math.abs(ratio - 1);
                
                // Escape condition usually at e >= 1
                if (e >= 1.0) isOpen = true;
            } else {
                // If invalid or kappa is 0 (pure kinetic), it's a line/escape
                e = 1.0; 
                isOpen = true;
            }

            // 4. Mass (M)
            // Rs = kappa^2 * rp
            // M = (Rs * c^2) / (2G)
            const Rs = (kappa_p**2) * rpInput;
            const M = (Rs * C**2) / (2 * G);

            return { z: zInput, beta: betaInput, r_p: rpInput, Q_p, kappa_p, e, M, validState, isOpen };
        }, [zInput, betaInput, rpInput]);

        // --- VISUALIZATION LOOP ---
        useEffect(() => {
            const canvas = canvasRef.current;
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            // DPI Fix
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            
            const w = rect.width;
            const h = rect.height;
            const cx = w / 2;
            const cy = h / 2;

            // Clear
            ctx.fillStyle = '#050505';
            ctx.fillRect(0, 0, w, h);

            // Grid
            ctx.strokeStyle = '#111'; ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(cx, 0); ctx.lineTo(cx, h); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0, cy); ctx.lineTo(w, cy); ctx.stroke();

            // Error State
            if (!physics.validState) {
                ctx.fillStyle = '#FF4444'; ctx.textAlign = 'center'; ctx.font = '12px monospace';
                ctx.fillText(`INVALID STATE: β_p (${physics.beta.toFixed(3)}) > Q_p (${physics.Q_p.toFixed(3)})`, cx, cy - 20);
                return;
            }

            // --- ORBIT DRAWING (a=1 Normalized) ---
            let scale = Math.min(w, h) * 0.35;
            if (physics.e > 0.9) scale *= 0.6; // Zoom out for large orbits

            ctx.beginPath();
            ctx.lineWidth = 2;
            
            if (physics.e < 0.02) ctx.strokeStyle = '#00FF88'; // Circle
            else if (physics.isOpen) ctx.strokeStyle = '#FF4444'; // Escape
            else ctx.strokeStyle = '#00F0FF'; // Ellipse

            const steps = 400;
            let limit = Math.PI;
            if (physics.isOpen) limit = Math.acos(-1 / physics.e) - 0.15; // Asymptote limit

            let first = true;
            for (let i = 0; i <= steps; i++) {
                const t = (i / steps) * 2 * limit - limit;
                // Polar: r = |1-e^2| / (1 + e*cos(t))
                const p_norm = Math.abs(1 - physics.e**2); 
                const r = p_norm / (1 + physics.e * Math.cos(t));
                const r_px = r * scale;
                
                const x = r_px * Math.cos(t);
                const y = r_px * Math.sin(t);

                if (first) { ctx.moveTo(cx + x, cy - y); first = false; }
                else { ctx.lineTo(cx + x, cy - y); }
            }
            ctx.stroke();

            // Focus
            ctx.fillStyle = '#FFF'; ctx.beginPath(); ctx.arc(cx, cy, 3, 0, Math.PI*2); ctx.fill();

            // --- TRIANGLE VISUALIZATION (Bottom Right) ---
            // Only draw if valid
            if (physics.validState && physics.kappa_p > 0) {
                const tx = w - 60;
                const ty = h - 50;
                const tScale = 100; // Bigger triangle

                const b_len = physics.beta * tScale;
                const k_len = physics.kappa_p * tScale;

                ctx.lineWidth = 2;

                // 1. Beta Leg (Horizontal)
                ctx.strokeStyle = '#00F0FF'; 
                ctx.beginPath(); ctx.moveTo(tx, ty); ctx.lineTo(tx + b_len, ty); ctx.stroke();

                // 2. Kappa Leg (Vertical)
                ctx.strokeStyle = '#FF0055'; 
                ctx.beginPath(); ctx.moveTo(tx, ty); ctx.lineTo(tx, ty - k_len); ctx.stroke();

                // 3. Q Hypotenuse
                ctx.strokeStyle = '#FFF'; ctx.setLineDash([4, 4]);
                ctx.beginPath(); ctx.moveTo(tx + b_len, ty); ctx.lineTo(tx, ty - k_len); ctx.stroke();
                ctx.setLineDash([]);

                // Labels
                ctx.fillStyle = '#ccc'; ctx.font = '11px monospace'; ctx.textAlign = 'center';
                ctx.fillText('β_p', tx + b_len/2, ty + 15);
                ctx.fillText('κ_p', tx - 15, ty - k_len/2);
                ctx.fillStyle = '#FFF';
                ctx.fillText('Q_p', tx + b_len/2 + 5, ty - k_len/2 - 5);
            }

        }, [physics]);

        // Styles
        const labelStyle = { color: '#888', fontSize: '10px', textTransform: 'uppercase', marginBottom: '4px' };
        const valStyle = { color: '#FFF', fontFamily: 'monospace', fontSize: '14px' };
        const inputRowStyle = { display: 'flex', flexDirection: 'column', gap: '5px', flex: 1, minWidth: '200px' };
        const numInputStyle = { background: '#111', border: '1px solid #333', color: '#fff', padding: '4px', width: '70px', textAlign: 'right', fontSize: '12px' };

        return (
            <div style={{ 
                fontFamily: "'Courier New', monospace", 
                background: '#0a0a0a', 
                border: '1px solid #333', 
                borderRadius: '8px',
                display: 'flex',
                flexDirection: 'column',
                height: '600px', // Fixed height for consistency
                overflow: 'hidden'
            }}>
                
                {/* --- TOP: OUTPUTS --- */}
                <div style={{ 
                    display: 'flex', justifyContent: 'space-between', alignItems: 'center', 
                    padding: '15px 20px', background: '#000', borderBottom: '1px solid #222' 
                }}>
                    {/* Mass Output */}
                    <div>
                        <div style={labelStyle}>Derived Mass (M)</div>
                        <div style={{color: '#FFD700', fontSize: '16px', fontWeight: 'bold'}}>
                            {(physics.M / M_SUN).toFixed(2)} M☉
                        </div>
                        <div style={{fontSize: '10px', color: '#444'}}>
                            {physics.M.toExponential(2)} kg
                        </div>
                    </div>

                    {/* Stability Status */}
                    <div style={{textAlign: 'right'}}>
                        <div style={labelStyle}>Trajectory</div>
                        <div style={{color: physics.isOpen ? '#FF4444' : '#00FF88', fontSize: '14px'}}>
                            {physics.isOpen ? 'OPEN / ESCAPE' : 'CLOSED ORBIT'}
                        </div>
                        <div style={{fontSize: '11px', color: '#666'}}>e = {physics.e.toFixed(4)}</div>
                    </div>
                </div>

                {/* --- MIDDLE: VISUALIZATION --- */}
                <div style={{ flex: 1, position: 'relative', background: '#050505' }}>
                    <canvas ref={canvasRef} style={{width: '100%', height: '100%', display: 'block'}} />
                    <div style={{position: 'absolute', bottom: 10, left: 10, fontSize: '9px', color: '#333'}}>
                        R.O.M. KERNEL v2.1 | NORMALIZED VIEW
                    </div>
                </div>

                {/* --- BOTTOM: INPUTS --- */}
                <div style={{ 
                    padding: '20px', background: '#080808', borderTop: '1px solid #222',
                    display: 'flex', flexWrap: 'wrap', gap: '30px', alignItems: 'flex-end'
                }}>
                    
                    {/* INPUT 1: z_Qp */}
                    <div style={inputRowStyle}>
                        <div style={{display: 'flex', justifyContent: 'space-between'}}>
                            <span style={labelStyle}>Shift (z_Qp)</span>
                            <span style={{color: '#FF0055', fontSize:'12px'}}>{physics.z.toFixed(4)}</span>
                        </div>
                        <div style={{display: 'flex', gap: '10px', alignItems: 'center'}}>
                            <input 
                                type="range" min="0.01" max="2.0" step="0.01"
                                value={zInput} onChange={e => setZInput(parseFloat(e.target.value))}
                                style={{flex: 1, accentColor: '#FF0055'}}
                            />
                            <input 
                                type="number" step="0.01" min="0"
                                value={zInput} onChange={e => setZInput(parseFloat(e.target.value))}
                                style={numInputStyle}
                            />
                        </div>
                    </div>

                    {/* INPUT 2: Beta_p */}
                    <div style={inputRowStyle}>
                        <div style={{display: 'flex', justifyContent: 'space-between'}}>
                            <span style={labelStyle}>Velocity (β_p)</span>
                            <span style={{color: '#00F0FF', fontSize:'12px'}}>{physics.beta.toFixed(4)}</span>
                        </div>
                        <div style={{display: 'flex', gap: '10px', alignItems: 'center'}}>
                            <input 
                                type="range" min="0.001" max={physics.Q_p || 1} step="0.001"
                                value={betaInput} onChange={e => setBetaInput(parseFloat(e.target.value))}
                                style={{flex: 1, accentColor: '#00F0FF'}}
                            />
                            <input 
                                type="number" step="0.001" min="0"
                                value={betaInput} onChange={e => setBetaInput(parseFloat(e.target.value))}
                                style={numInputStyle}
                            />
                        </div>
                        <div style={{fontSize: '9px', color: '#444'}}>
                            Max Limit: Q_p ({physics.Q_p.toFixed(3)})
                        </div>
                    </div>

                    {/* INPUT 3: r_p (Physical) */}
                    <div style={inputRowStyle}>
                        <span style={labelStyle}>Periapsis r_p (m)</span>
                        <input 
                            type="number" 
                            value={rpInput} onChange={e => setRpInput(parseFloat(e.target.value))}
                            style={{...numInputStyle, width: '100%', textAlign: 'left', padding: '8px'}}
                        />
                    </div>

                </div>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('rom-engine-root'));
    root.render(<RomEngine />);
</script>
{% endraw %}