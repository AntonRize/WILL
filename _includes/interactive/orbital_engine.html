<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WILL Anchor Solver v9.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body { background-color: #050505; color: #e5e5e5; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .glass-panel { background: rgba(20, 20, 25, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .input-group label { display: block; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #888; margin-bottom: 4px; }
        .input-field { background: #0a0a0a; border: 1px solid #333; color: #fff; font-family: 'Courier New', monospace; width: 100%; padding: 6px; font-size: 0.9rem; border-radius: 4px; outline: none; transition: border-color 0.2s; }
        .input-field:focus { border-color: #a855f7; }
        .stat-value { font-family: 'Courier New', monospace; font-weight: bold; }
        canvas { border-radius: 8px; border: 1px solid #333; }
        
        /* Range Slider Styling */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: #a855f7; cursor: pointer; margin-top: -5px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 2px; background: #333; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <header class="h-12 border-b border-gray-800 bg-black/50 flex items-center px-6 justify-between shrink-0">
        <div class="flex items-center gap-2">
            <div class="w-3 h-3 rounded-full bg-purple-600 shadow-[0_0_10px_rgba(168,85,247,0.5)]"></div>
            <h1 class="font-bold tracking-widest text-sm text-gray-200">WILL <span class="text-purple-500">ANCHOR SOLVER</span></h1>
        </div>
        <div class="text-[10px] text-gray-500 font-mono">RG METRIC VERIFIED</div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <div class="w-96 glass-panel border-r-0 flex flex-col overflow-y-auto shrink-0 z-10">
            
            <div class="p-5 border-b border-gray-800">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xs font-bold text-purple-400 uppercase tracking-wider">Primary Anchor (Pericenter)</h2>
                    <span class="text-[9px] bg-purple-900/30 text-purple-300 px-1.5 py-0.5 rounded border border-purple-800">REQUIRED</span>
                </div>
                
                <div class="space-y-4">
                    <div class="input-group">
                        <label>Total Spectral Shift \(Q_p\) (\(\sqrt{\kappa^2+\beta^2}\))</label>
                        <div class="flex items-center gap-2">
                            <input type="range" min="0.001" max="0.999" step="0.001" value="0.05" oninput="syncInput('q_p', this.value); solve();">
                            <input type="number" id="q_p" class="input-field w-20 text-right" value="0.05" step="0.0001" oninput="solve()">
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Eccentricity \(e_c\)</label>
                        <div class="flex items-center gap-2">
                            <input type="range" min="0.01" max="0.99" step="0.01" value="0.8" oninput="syncInput('e_c', this.value); solve();">
                            <input type="number" id="e_c" class="input-field w-20 text-right" value="0.8" step="0.01" oninput="solve()">
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Pericenter Radius \(r_p\) (meters)</label>
                        <input type="number" id="r_p" class="input-field" value="1.8e13" step="1e10" oninput="solve()">
                        <div class="text-[9px] text-gray-500 mt-1 text-right" id="rp_au">-</div>
                    </div>
                </div>
            </div>

            <div class="p-5 border-b border-gray-800 bg-black/20">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xs font-bold text-blue-400 uppercase tracking-wider">Validation (Apocenter)</h2>
                    <span class="text-[9px] text-gray-600 border border-gray-800 px-1.5 py-0.5 rounded">OPTIONAL</span>
                </div>
                
                <div class="space-y-4 opacity-75 hover:opacity-100 transition-opacity">
                    <div class="input-group">
                        <label>Apocenter Shift \(Q_a\)</label>
                        <input type="number" id="q_a" class="input-field" placeholder="Optional..." step="0.0001" oninput="solve()">
                    </div>
                     <div class="input-group">
                        <label>Apocenter Radius \(r_a\) (meters)</label>
                        <input type="number" id="r_a" class="input-field" placeholder="Auto-calculated if empty..." step="1e10" oninput="solve()">
                    </div>
                </div>
            </div>

            <div class="p-5 mt-auto bg-gradient-to-t from-purple-900/10 to-transparent">
                <div class="text-[10px] text-gray-500 mb-2 font-bold">DERIVED MASS (WILL METHOD)</div>
                <div class="flex items-baseline gap-2">
                    <span id="res_mass" class="text-3xl font-bold text-white tracking-tighter">-</span>
                    <span class="text-sm text-gray-400">\(M_{\odot}\)</span>
                </div>
                <div class="h-px bg-gray-800 my-3"></div>
                <div class="grid grid-cols-2 gap-4 text-[10px]">
                    <div>
                        <span class="text-gray-500 block">Schwarzschild \(R_s\)</span>
                        <span id="res_rs" class="text-purple-300 font-mono">-</span>
                    </div>
                    <div>
                        <span class="text-gray-500 block">Separation \(\kappa_p\)</span>
                        <span id="res_kappa" class="text-green-300 font-mono">-</span>
                    </div>
                </div>
                
                <div id="consistency_box" class="hidden mt-4 p-2 rounded border text-[10px] flex justify-between items-center">
                    <span class="font-bold">CONSISTENCY CHECK:</span>
                    <span id="consistency_val" class="font-mono">-</span>
                </div>
            </div>
        </div>

        <div class="flex-1 bg-black relative flex flex-col">
            <canvas id="orbitCanvas" class="w-full h-full object-cover"></canvas>
            
            <div class="absolute top-4 right-4 text-right pointer-events-none">
                <div class="glass-panel p-3 rounded inline-block text-left">
                    <div class="text-[9px] text-gray-500 uppercase mb-1">Vector Decomposition</div>
                    <div class="flex items-center gap-2 text-xs font-mono mb-1">
                        <span class="w-2 h-2 rounded-full bg-red-500"></span>
                        <span class="text-gray-300">\(Q\) Total</span>
                        <span id="val_q" class="ml-auto font-bold text-white">0.000</span>
                    </div>
                    <div class="flex items-center gap-2 text-xs font-mono mb-1">
                        <span class="w-2 h-2 rounded-full bg-green-500"></span>
                        <span class="text-gray-300">\(\kappa\) Grav</span>
                        <span id="val_k" class="ml-auto text-green-400">0.000</span>
                    </div>
                    <div class="flex items-center gap-2 text-xs font-mono">
                        <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                        <span class="text-gray-300">\(\beta\) Kin</span>
                        <span id="val_b" class="ml-auto text-blue-400">0.000</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- PHYSICS CONSTANTS ---
    const G = 6.67430e-11;
    const c = 299792458.0; 
    const M_sun_kg = 1.98847e30;
    const AU = 1.496e11;

    // --- DOM ELEMENTS ---
    const cvs = document.getElementById('orbitCanvas');
    const ctx = cvs.getContext('2d');

    // --- STATE ---
    let state = {
        Qp: 0, ec: 0, rp: 0,
        kp: 0, bp: 0,
        Rs: 0, Mass: 0,
        Qa: 0, ra: 0
    };

    function syncInput(id, val) {
        document.getElementById(id).value = val;
    }

    function solve() {
        // 1. Get Inputs
        const Qp = parseFloat(document.getElementById('q_p').value);
        const ec = parseFloat(document.getElementById('e_c').value);
        const rp = parseFloat(document.getElementById('r_p').value);
        
        let Qa = parseFloat(document.getElementById('q_a').value);
        let ra_in = parseFloat(document.getElementById('r_a').value);

        if(isNaN(Qp) || isNaN(ec) || isNaN(rp)) return;

        // 2. WILL SEPARATION PROTOCOL (PERICENTER)
        // Formula: kappa_p = Q_p * sqrt( 2 / (3 + e) )
        // Because beta_p^2 = kappa_p^2 * (1+e)/2
        // And Q^2 = k^2 + b^2
        const separation_factor = Math.sqrt(2 / (3 + ec));
        const kp = Qp * separation_factor;
        const bp = Math.sqrt(Qp*Qp - kp*kp);

        // 3. PHYSICAL SCALING
        // Rs = kp^2 * rp
        const Rs = (kp * kp) * rp;
        
        // Mass = (Rs * c^2) / 2G
        const Mass_kg = (Rs * c * c) / (2 * G);
        const Mass_solar = Mass_kg / M_sun_kg;

        // 4. APOCENTER CHECK (Optional)
        // If ra is not provided, calculate geometric ra
        const ra_geo = rp * (1 + ec) / (1 - ec);
        
        let consistency = null;
        let mass_apo = null;

        if (!isNaN(Qa)) {
             // Separation at Apocenter
             // Formula: kappa_a = Q_a * sqrt( 2 / (3 - e) )
             // Wait, let's derive: beta_a^2 = kappa_a^2 * (1-e)/2
             // Q_a^2 = k_a^2 * (1 + (1-e)/2) = k_a^2 * (3-e)/2
             const sep_factor_a = Math.sqrt(2 / (3 - ec));
             const ka = Qa * sep_factor_a;
             
             // Check radius logic
             const ra_use = isNaN(ra_in) ? ra_geo : ra_in;
             
             const Rs_apo = (ka * ka) * ra_use;
             mass_apo = (Rs_apo * c * c) / (2 * G);
             const mass_apo_solar = mass_apo / M_sun_kg;

             const diff = Math.abs(Mass_solar - mass_apo_solar);
             const avg = (Mass_solar + mass_apo_solar) / 2;
             const pct = (diff / avg) * 100;
             
             consistency = { pct, m1: Mass_solar, m2: mass_apo_solar };
        }

        // 5. UPDATE STATE
        state = { Qp, ec, rp, kp, bp, Rs, Mass: Mass_solar, Qa, ra: ra_geo, consistency };

        updateUI();
        draw();
    }

    function updateUI() {
        // RP in AU
        const rp_au = state.rp / AU;
        document.getElementById('rp_au').innerText = rp_au < 0.1 ? (state.rp/1000).toExponential(2) + " km" : rp_au.toFixed(2) + " AU";

        // Mass
        const mElem = document.getElementById('res_mass');
        if(state.Mass > 1e6) {
            mElem.innerText = (state.Mass / 1e6).toFixed(2) + " M";
        } else {
            mElem.innerText = state.Mass.toLocaleString(undefined, {maximumFractionDigits:0});
        }

        // Rs
        document.getElementById('res_rs').innerText = (state.Rs / 1000).toFixed(1) + " km";
        
        // Kappa
        document.getElementById('res_kappa').innerText = state.kp.toFixed(6);

        // Visualizer Values
        document.getElementById('val_q').innerText = state.Qp.toFixed(4);
        document.getElementById('val_k').innerText = state.kp.toFixed(4);
        document.getElementById('val_b').innerText = state.bp.toFixed(4);

        // Consistency
        const cBox = document.getElementById('consistency_box');
        const cVal = document.getElementById('consistency_val');
        if(state.consistency) {
            cBox.classList.remove('hidden');
            const pct = state.consistency.pct;
            cVal.innerText = pct.toFixed(2) + "% DIFF";
            if(pct < 2) {
                cBox.className = "mt-4 p-2 rounded border text-[10px] flex justify-between items-center bg-green-900/20 border-green-800 text-green-400";
            } else if (pct < 10) {
                cBox.className = "mt-4 p-2 rounded border text-[10px] flex justify-between items-center bg-yellow-900/20 border-yellow-800 text-yellow-400";
            } else {
                cBox.className = "mt-4 p-2 rounded border text-[10px] flex justify-between items-center bg-red-900/20 border-red-800 text-red-400";
            }
        } else {
            cBox.classList.add('hidden');
        }
    }

    // --- RENDER LOOP ---
    function resize() {
        cvs.width = cvs.parentElement.clientWidth;
        cvs.height = cvs.parentElement.clientHeight;
        draw();
    }
    window.addEventListener('resize', resize);

    function draw() {
        const w = cvs.width;
        const h = cvs.height;
        const cx = w/2;
        const cy = h/2;

        ctx.fillStyle = "#000";
        ctx.fillRect(0,0,w,h);

        // Grid
        ctx.strokeStyle = "#111";
        ctx.lineWidth = 1;
        ctx.beginPath();
        for(let i=0; i<w; i+=40) { ctx.moveTo(i,0); ctx.lineTo(i,h); }
        for(let i=0; i<h; i+=40) { ctx.moveTo(0,i); ctx.lineTo(w,i); }
        ctx.stroke();

        if(state.Mass === 0) return;

        // Auto Scale
        // We want to fit the orbit 2*a roughly into 80% of width
        const a = state.rp / (1 - state.ec);
        // Scale factor: pixels per meter
        const scale = (Math.min(w,h) * 0.4) / a; 

        // Draw Central Body (Black Hole)
        // Rs is usually too small to see, so we draw a symbol
        ctx.fillStyle = "#fff";
        ctx.beginPath(); ctx.arc(cx, cy, 3, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = "rgba(168, 85, 247, 0.5)";
        ctx.beginPath(); ctx.arc(cx, cy, 6, 0, Math.PI*2); ctx.stroke();

        // Draw Orbit
        ctx.strokeStyle = "#444";
        ctx.lineWidth = 2;
        ctx.beginPath();
        
        // Ellipse parameters
        // Center of ellipse is offset from focus (0,0) by c_linear = a * e
        const c_linear = a * state.ec;
        const b = a * Math.sqrt(1 - state.ec*state.ec);
        
        // Drawing step
        for(let theta = 0; theta <= Math.PI*2; theta += 0.05) {
            // Polar equation from focus
            const r = (a * (1 - state.ec*state.ec)) / (1 + state.ec * Math.cos(theta));
            const x = cx + r * Math.cos(theta) * scale;
            const y = cy + r * Math.sin(theta) * scale; // Canvas Y is down, but simple orbit doesn't matter
            if(theta===0) ctx.moveTo(x,y);
            else ctx.lineTo(x,y);
        }
        ctx.stroke();

        // Draw Pericenter Vector Triangle
        // Pericenter is at theta = 0 (Right side in standard polar)
        const px = cx + state.rp * scale;
        const py = cy;

        // Vector Visualization (Magnified)
        const vScale = 100; // Arbitrary length for UI
        const kLen = state.kp * 2000; // Visual scaling
        const bLen = state.bp * 2000;

        // Draw Point
        ctx.fillStyle = "#a855f7";
        ctx.beginPath(); ctx.arc(px, py, 4, 0, Math.PI*2); ctx.fill();

        // Draw Triangle (local ortho frame concept)
        // Base (Radial/Potential) - Green
        ctx.strokeStyle = "#22c55e"; ctx.lineWidth = 3;
        ctx.beginPath(); ctx.moveTo(px, py); ctx.lineTo(px - kLen, py); ctx.stroke(); // Inward
        
        // Height (Tangential/Kinetic) - Blue
        ctx.strokeStyle = "#3b82f6";
        ctx.beginPath(); ctx.moveTo(px, py); ctx.lineTo(px, py - bLen); ctx.stroke();

        // Hypotenuse (Total Q) - Red
        ctx.strokeStyle = "#ef4444"; ctx.setLineDash([2,2]);
        ctx.beginPath(); ctx.moveTo(px - kLen, py); ctx.lineTo(px, py - bLen); ctx.stroke();
        ctx.setLineDash([]);

        // Labels
        ctx.fillStyle = "#fff"; ctx.font = "10px monospace";
        ctx.fillText("PERICENTER", px + 10, py);
    }

    // Init
    resize();
    solve();

</script>
</body>
</html>