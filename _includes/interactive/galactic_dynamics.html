<div id="overall-median-inline" class="mt-4 text-cyan-200 font-semibold"></div>

<div id="type-filter" class="bg-gray-800/50 p-4 rounded-lg mb-4">
  <h4 class="text-lg font-bold text-gray-200 mb-2">Filter by Hubble Type:</h4>
  <div id="type-checkboxes" class="flex flex-wrap gap-4 text-gray-300"></div>
  <button id="analyze-types-btn" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded">Analyze RMSE by Type</button>
</div>

<div id="type-plot" class="bg-gray-800/50 p-4 rounded-lg mb-4" style="display:none">
  <div id="overall-median" class="text-gray-200 font-semibold mb-3"></div>
  <div id="rmse-histogram"></div>
</div>

<div class="calculator-container bg-gray-800/50 p-6 rounded-lg">
  <div id="loader">Loading SPARC Database...</div>

  <div id="calculator-body" style="display:none">
    <div class="controls-grid">
      <div class="control-group">
        <label for="galaxy-select">Select Galaxy:</label>
        <select id="galaxy-select" class="form-control"></select>
      </div>

      <div class="control-group">
        <label for="ystar-slider">Stellar M/L Ratio (Υ*):
          <span id="ystar-value" class="param-display">0.66</span>
        </label>
        <input type="range" id="ystar-slider" class="form-range" min="0.00" max="2.00" step="0.01" value="0.66" />
      </div>
    </div>

    <div id="galaxy-info" class="bg-gray-800/50 p-4 rounded-lg mb-4"></div>

    <div id="results"></div>
    <div id="warning" class="warning"></div>

    <div class="plot-wrapper">
      <div class="plot-box"><div id="plot-div"></div></div>
      <div class="plot-box"><div id="plot-div-components"></div></div>
    </div>
  </div>
</div>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

<style>
  .calculator-container{background-color:rgba(31,41,55,.5);border-radius:15px;padding:30px 40px;margin:20px auto;box-shadow:0 10px 40px rgba(0,0,0,.3);border:1px solid #374151;max-width:1000px}
  .controls-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:25px;margin-bottom:20px}
  .control-group{display:flex;flex-direction:column}
  .control-group label{margin-bottom:10px;font-weight:600;color:#d1d5db}
  .form-control,.form-range{width:100%;padding:10px;border-radius:5px;border:1px solid #4b5563;background-color:#374151;color:#d1d5db;box-sizing:border-box}
  .param-display{font-weight:700;color:#67e8f9}
  #results{text-align:center;font-size:1.25em;font-weight:700;margin:20px 0 25px;color:#d1d5db;padding:15px;background:#374151;border-radius:8px}
  #warning{text-align:center;color:#f87171;font-weight:700;margin-top:10px}
  .plot-wrapper{display:flex;flex-wrap:wrap;gap:20px;margin-top:25px;padding-top:25px;border-top:1px solid #4b5563;justify-content:center}
  .plot-box{flex:1 1 45%;min-width:350px;max-width:600px;height:500px;border-radius:8px;background:#1f2937;position:relative}
  #loader{text-align:center;font-size:1.5em;padding:50px;color:#9ca3af}
</style>

<script>
  /* CONFIG & GLOBALS */
  const RAW_BASE = "https://raw.githubusercontent.com/AntonRize/WILL/main/SPARC%20DATA/";
  const URL_TABLE1 = RAW_BASE + "table1.dat";
  const URL_TABLE2 = RAW_BASE + "table2.dat";

  let galaxyData = {};
  let galaxyMeta = {};
  let distinctTypes = [];
  const defaultValues = { yStar: 0.66 };
  const hubbleTypes = ["S0","Sa","Sab","Sb","Sbc","Sc","Scd","Sd","Sdm","Sm","Im","BCD"];

  /* DOM Elements */
  const loader=document.getElementById("loader");
  const bodyEl=document.getElementById("calculator-body");
  const galaxySelect=document.getElementById("galaxy-select");
  const ystarSlider=document.getElementById("ystar-slider");
  const ystarValueSpan=document.getElementById("ystar-value");
  const resultsDiv=document.getElementById("results");
  const plotDiv=document.getElementById("plot-div");
  const plotDivComponents=document.getElementById("plot-div-components");
  const galaxyInfoDiv=document.getElementById("galaxy-info");

  /* LOAD DATA */
  async function loadData(){
    try{
      if(!window.Plotly) throw new Error("Plotly failed to load.");
      const [t1Res,t2Res]=await Promise.all([fetch(URL_TABLE1),fetch(URL_TABLE2)]);
      if(!t1Res.ok||!t2Res.ok) throw new Error("Failed to fetch SPARC tables.");

      const t1Text=await t1Res.text();
      const t2Text=await t2Res.text();

      // Parse Table 1 (Metadata including R_disk)
      const typeSet = new Set();
      t1Text.trim().split("\n").forEach(line=>{
        if(line.startsWith("#")) return;
        const name=line.substring(0,11).trim();
        const rest=line.substring(11).trim().split(/\s+/);
        if(rest.length<18) return;
        
        // R_disk is column 10
        const rDisk = +rest[10]; 
        
        galaxyMeta[name]={
          Name:name,
          Rdisk: rDisk, // <--- CRITICAL PARAMETER FROM OBSERVATION
          Dist:+rest[1], 
          L36:+rest[6],
          TypeRaw:rest[0]
        };
        // Type handling...
        const typeId = parseInt(rest[0],10);
        const typeLabel = (hubbleTypes[typeId]!==undefined) ? hubbleTypes[typeId] : String(rest[0]);
        galaxyMeta[name].TypeLabel = typeLabel;
        typeSet.add(typeLabel);
      });
      distinctTypes = Array.from(typeSet).sort();

      // Parse Table 2 (Rotation Curves)
      t2Text.trim().split("\n").forEach(line=>{
        if(line.startsWith("#")) return;
        const p=line.trim().split(/\s+/);
        if(p.length<8) return;
        const row={ Name:p[0], Dist:+p[1], Rad:+p[2], Vobs:+p[3], Vobs_err:+p[4], Vgas:+p[5], Vdisk:+p[6], Vbul:+p[7] };
        (galaxyData[row.Name] ||= []).push(row);
      });

      // Init UI
      Object.keys(galaxyData).sort().forEach(name=>{
        if(galaxyData[name].length<3) return;
        const opt=document.createElement("option");
        opt.value=name; opt.textContent=name; galaxySelect.appendChild(opt);
      });
      initGalaxyTypeCheckboxes();
      loader.style.display="none"; bodyEl.style.display="block";
      galaxySelect.selectedIndex=0;
      updateGalaxyInfo();
      updateAll();
    }catch(err){
      loader.textContent = "Error loading data.";
      console.error(err);
    }
  }

  /* PHYSICS: GEOMETRIC SCREENING (NO FREE PARAMETERS) */
  function seriesQWILL(galaxyName, yStar){
    const data = (galaxyData[galaxyName]||[]).slice().sort((a,b)=>a.Rad-b.Rad);
    const meta = galaxyMeta[galaxyName];
    // R_disk is an observed photometric parameter, not a fit.
    const R_disk = meta ? meta.Rdisk : 1.0; 

    const r = [], Vobs = [], Vbary = [], Vq = [];
    const Vgas_comp = [], Vdisk_scaled = [], Vbulge_scaled = [];

    for(const d of data){
      const vo = (Number.isFinite(d.Vobs) && d.Vobs >= 0) ? d.Vobs : NaN;
      if(!Number.isFinite(vo)) continue;

      const vg = d.Vgas > 0 ? d.Vgas : 0;
      const vd = d.Vdisk > 0 ? d.Vdisk : 0;
      const vb = d.Vbul > 0 ? d.Vbul : 0;

      // 1. Baryonic Velocity
      const vbary2 = vg*vg + yStar * (vd*vd + vb*vb);
      const vbary  = Math.sqrt(Math.max(0, vbary2));
      
      // 2. Screening Factor (Geometric)
      // The vacuum contribution is suppressed when r < R_disk.
      // It emerges when r > R_disk.
      // Factor 3 is geometric scaling.
      const chi = (3 * R_disk) / (d.Rad + 0.001); 
      
      // Universal Law:
      const factor = Math.sqrt(1 + 2 * Math.exp(-chi));
      const vq = vbary * factor;

      r.push(d.Rad);
      Vobs.push(vo);
      Vbary.push(vbary);
      Vq.push(vq);
      
      // Store components for plotting
      Vgas_comp.push(vg);
      Vdisk_scaled.push(Math.sqrt(yStar) * vd);
      Vbulge_scaled.push(Math.sqrt(yStar) * vb);
    }
    return { r, Vobs, Vbary, Vq, components: { Vgas: Vgas_comp, Vdisk_scaled, Vbulge_scaled } };
  }

  /* HELPER FUNCTIONS (RMSE, COLORS, ETC) */
  function rmse(obs, pred){
    let s=0, k=0;
    for(let i=0;i<Math.min(obs.length,pred.length);i++){
      if(Number.isFinite(obs[i]) && Number.isFinite(pred[i])){ s+=(obs[i]-pred[i])**2; k++; }
    }
    return k>0 ? Math.sqrt(s/k) : NaN;
  }
  
  function blueRedColor(v, vmin, vmax){
    if(!isFinite(v) || !isFinite(vmin) || !isFinite(vmax) || vmax<=vmin) return "rgb(128,128,128)";
    const t = (v - vmin) / (vmax - vmin);
    const r = 59 + (239-59)*t;
    const g = 130 + (68-130)*t;
    const b = 246 + (68-246)*t;
    return `rgb(${Math.round(r)},${Math.round(g)},${Math.round(b)})`;
  }

  function computeOverallMedianRMSE(yStar){
    const values=[];
    for(const name in galaxyData){
      const S=seriesQWILL(name,yStar);
      if(S.Vobs.length===S.Vq.length && S.Vobs.length>0) values.push(rmse(S.Vobs,S.Vq));
    }
    if(!values.length) return NaN;
    const sorted=values.slice().sort((a,b)=>a-b);
    const mid=Math.floor(sorted.length/2);
    return (sorted.length%2===0) ? (sorted[mid-1]+sorted[mid])/2 : sorted[mid];
  }

  function updateOverallMedianInline(){
    const yStar=(+ystarSlider.value || defaultValues.yStar);
    const med=computeOverallMedianRMSE(yStar);
    const el=document.getElementById("overall-median-inline");
    if(Number.isFinite(med)){
      el.innerHTML = `Overall <b>Median RMSE</b> (all types, Υ*=${yStar.toFixed(2)}): <b>${med.toFixed(2)} km/s</b>`;
    } else {
      el.textContent = "";
    }
  }

  function updateAll(){
    const name=galaxySelect.value; if(!name) return;
    const yStar = (+ystarSlider.value || defaultValues.yStar);
    ystarValueSpan.textContent = yStar.toFixed(2);

    const S = seriesQWILL(name,yStar);
    const R = rmse(S.Vobs,S.Vq);
    resultsDiv.textContent = `RMSE: ${isFinite(R)?R.toFixed(2):"—"} km/s`;
    updateOverallMedianInline();

    const ymax = Math.max(1, ...S.Vobs, ...S.Vq);
    const layoutBase = {
      xaxis:{ title:"r (kpc)", color:"#d1d5db", gridcolor:"#4b5563" },
      yaxis:{ title:"Velocity (km/s)", color:"#d1d5db", gridcolor:"#4b5563", range:[0, ymax*1.1] },
      legend:{ orientation:"h", bgcolor:"rgba(31,41,55,0.9)", font:{color:"#d1d5db"} },
      margin:{ l:60, r:30, b:50, t:60 },
      paper_bgcolor:"transparent", plot_bgcolor:"#1f2937", font:{ color:"#d1d5db" }
    };

    Plotly.react(
      plotDiv,
      [
        { x:S.r, y:S.Vobs, mode:"markers", name:"Observed", marker:{ color:"#d1d5db", size:8 }},
        { x:S.r, y:S.Vbary, mode:"lines", name:"Baryonic", line:{ color:"#9ca3af", dash:"dash" }},
        { x:S.r, y:S.Vq,    mode:"lines", name:"WILL Predicted", line:{ color:"#67e8f9", width:4 }}
      ],
      { ...layoutBase, title:`Rotation Curve for ${name}` }
    );

    Plotly.react(
      plotDivComponents,
      [
        { x:S.r, y:S.Vobs,                     mode:"markers", name:"Observed", marker:{ color:"#9ca3af", size:6, symbol:"circle-open" }},
        { x:S.r, y:S.components.Vgas,          mode:"lines",   name:"Gas",       line:{ color:"#10b981" }},
        { x:S.r, y:S.components.Vdisk_scaled,  mode:"lines",   name:"Disk × Υ*", line:{ color:"#3b82f6" }},
        { x:S.r, y:S.components.Vbulge_scaled, mode:"lines",   name:"Bulge × Υ*",line:{ color:"#f59e0b" }}
      ],
      { ...layoutBase, title:`Baryonic Components for ${name}` }
    );
  }

  function updateGalaxyInfo(){
     const meta=galaxyMeta[galaxySelect.value]; if(!meta) return;
     const hubbleLabel = meta.TypeLabel || meta.TypeRaw;
     galaxyInfoDiv.innerHTML = `
       <p><strong>Type:</strong> ${hubbleLabel}</p>
       <p><strong>Distance:</strong> ${meta.Dist} Mpc</p>
       <p><strong>R_disk:</strong> ${meta.Rdisk} kpc (Scale Length)</p>
       <p><strong>Luminosity:</strong> ${meta.L36} G L&#9737;</p>
     `;
  }

  /* HISTOGRAM HELPERS */
  function buildHistogramData(rmseValues, vInitValues, bins){
    const N = rmseValues.length; if(!N) return null;
    const B = bins || 20;
    const minRMSE = Math.min(...rmseValues);
    const maxRMSE = Math.max(...rmseValues);
    const binWidth = (maxRMSE - minRMSE) / B || 1;
    const counts = new Array(B).fill(0);
    const sumInit = new Array(B).fill(0);
    for(let i=0;i<N;i++){
      let idx = Math.floor((rmseValues[i]-minRMSE)/binWidth);
      if(idx>=B) idx = B-1; if(idx<0) idx=0;
      counts[idx] += 1;
      sumInit[idx] += (Number.isFinite(vInitValues[i]) ? vInitValues[i] : 0);
    }
    const avgInit = counts.map((c,i)=> c>0 ? sumInit[i]/c : 0);
    const minInit = Math.min(...avgInit.filter(x=>isFinite(x)));
    const maxInit = Math.max(...avgInit.filter(x=>isFinite(x)));
    const binCenters = Array.from({length: B}, (_,i)=> minRMSE + i*binWidth + binWidth/2);
    return {counts, avgInit, minInit, maxInit, binCenters, binWidth};
  }

  function analyzeSelectedTypes(){
    const selected = Array.from(document.querySelectorAll("#type-checkboxes input:checked")).map(cb=>cb.value);
    if(!selected.length){ alert("Select at least one galaxy type first."); return; }
    const yStar=+ystarSlider.value || defaultValues.yStar;
    const rmseValues=[];
    const vInitValues=[];
    for(const name in galaxyData){
      const meta=galaxyMeta[name]; if(!meta) continue;
      if(!selected.includes(meta.TypeLabel)) continue;
      const S=seriesQWILL(name,yStar);
      if(S.Vobs.length===S.Vq.length && S.Vobs.length>0){
        rmseValues.push(rmse(S.Vobs,S.Vq));
        vInitValues.push(S.Vobs[0]);
      }
    }
    if(!rmseValues.length){ alert("No galaxies matched."); return; }
    
    const N = rmseValues.length;
    const sorted = rmseValues.slice().sort((a,b)=>a-b);
    const mid = Math.floor(N/2);
    const median = (N%2===0) ? (sorted[mid-1]+sorted[mid])/2 : sorted[mid];

    document.getElementById("overall-median").innerHTML = `Types: <b>${selected.join(", ")}</b> — N = ${N} — <b>Median RMSE = ${median.toFixed(2)} km/s</b>`;

    const H = buildHistogramData(rmseValues, vInitValues, 20);
    const colors = H.avgInit.map(v => blueRedColor(v, H.minInit, H.maxInit));
    const trace = {
      type: "bar", x: H.binCenters, y: H.counts,
      marker: { color: colors, line: { color: "#111827", width: 1 } },
      width: H.binWidth*0.95
    };
    const layoutHist = {
      xaxis:{ title:"RMSE (km/s)", color:"#d1d5db" },
      yaxis:{ title:"Count", color:"#d1d5db" },
      paper_bgcolor:"transparent", plot_bgcolor:"#1f2937", font:{ color:"#d1d5db" },
      margin:{ l:40,r:20,t:20,b:40 }
    };
    Plotly.newPlot("rmse-histogram", [trace], layoutHist);
    document.getElementById("type-plot").style.display="block";
  }

  /* INIT LISTENERS */
  document.addEventListener("DOMContentLoaded", ()=>{
    loadData();
    document.getElementById("analyze-types-btn").addEventListener("click", analyzeSelectedTypes);
    document.getElementById("galaxy-select").addEventListener("change", ()=>{ updateGalaxyInfo(); updateAll(); });
    document.getElementById("ystar-slider").addEventListener("input", ()=>{ updateAll(); });
  });
</script>