---
layout: default
title: "WILL AI Assistant"
permalink: /assistant/
---

<div id="root"></div>

<style>
    body { margin: 0; background-color: #111827; } /* DOUBLE SCROLL FIX */
    textarea::-webkit-scrollbar{width:4px}
</style>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    const {useState, useEffect, useRef} = React;
    const FILES = [
        'WILL%20DATABASE/WILL%20PART%20I%20SR%20GR.txt',
        'WILL%20DATABASE/WILL%20PART%20II%20COSMO%20.txt',
        'WILL%20DATABASE/WILL%20PART%20III%20QM%20.txt'
    ];
    const CORE = `Î² (beta)=v/c  Â·  Îº (kappa)=vâ‚‘/c  Â·  ÎºÂ²=2Î²Â²`;
    const PROXY = 'https://proxy-flame-seven.vercel.app/api/gemini';
    const LOG_API = 'https://proxy-flame-seven.vercel.app/api/log';
    const QUICK = {
        'beta':  'Î² (beta) is the kinematic projection v / c. Together with Îº it obeys ÎºÂ² = 2 Î²Â².',
        'Î²':     'Î² (beta) is the kinematic projection v / c. Together with Îº it obeys ÎºÂ² = 2 Î²Â².',
        'kappa': 'Îº (kappa) is the gravitational projection vâ‚‘ / c. Relation ÎºÂ² = 2 Î²Â².',
        'Îº':     'Îº (kappa) is the gravitational projection vâ‚‘ / c. Relation ÎºÂ² = 2 Î²Â².'
    };
    function loadKB(){
        const base='https://raw.githubusercontent.com/AntonRize/WILL/main/';
        return Promise.all(FILES.map(p=>fetch(base+p).then(r=>{
            if(!r.ok)throw new Error('KB fetch '+r.status);
            return r.text();
        }))).then(t=>t.join('\n\n').replace(/\\beta/g,'Î² (beta)').replace(/\\kappa/g,'Îº (kappa)'));
    }
    function askGemini(prompt){
        return fetch(PROXY,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt})})
            .then(r=>r.text())
            .then(t=>{let d;try{d=JSON.parse(t);}catch{throw new Error(t);}if(!d.reply)throw new Error(d.error||'Proxy');return d.reply;});
    }
    const isRu=s=>/[Ð°-ÑÑ‘]/i.test(s);

    function App(){
        const [kb,setKb]=useState('');
        const [ks,setKs]=useState('loading');
        const welcome={
            id:0,
            txt:marked.parse("ðŸ‘‹ Welcome to the WILL Geometry Assistant!\n\nAsk me anything about the WILL Theory or its documents.\n\n**Disclaimer:** AI can make mistakes â€” so do you. Doublecheck with original WILL documents (.pdf)."),
            user:false,
            isWelcome:true,
            raw:"ðŸ‘‹ Welcome to the WILL Geometry Assistant! Ask me anything about the WILL Theory or its documents. Disclaimer: AI can make mistakes â€” so do you. Doublecheck with original WILL documents (.pdf)."
        };
        const [log,setLog]=useState([welcome]);
        const logRef=useRef([welcome]);
        const [inp,setInp]=useState('');
        const [busy,setBusy]=useState(false);
        const endRef=useRef(null);
        const textRef=useRef(null);

        useEffect(()=>{loadKB().then(d=>{setKb(d);setKs('ok');}).catch(()=>setKs('error'));},[]);
        useEffect(()=>{endRef.current?.scrollIntoView({behavior:'smooth'});},[log]);
        const push=(txt,user=false,raw=txt)=>{
            const content=user?txt:marked.parse(txt);
            const entry={id:Date.now()+Math.random(),txt:content,user,raw};
            logRef.current=[...logRef.current,entry];
            setLog(logRef.current);
        };

        function sendLog(){
            fetch(LOG_API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({log:logRef.current.map(m=>({user:m.user,raw:m.raw}))})}).catch(()=>{});
        }

async function send() {
    const q = inp.trim();
    if (!q || busy) return;

    push(q, true, q);
    setInp('');
    if (textRef.current) textRef.current.style.height = 'auto';

    const qKey = q.toLowerCase().replace('?', '');
    if (QUICK[qKey]) {
        push(QUICK[qKey], false, QUICK[qKey]);
        sendLog();
        return;
    }

    if (ks !== 'ok') {
        const msg = 'Knowledge base still loadingâ€¦';
        push(msg, false, msg);
        sendLog();
        return;
    }
    
    setBusy(true);

    // Define 'lang' here to make it accessible in the 'catch' block
    const lang = isRu(q) ? 'Russian' : 'English';

    try {
        const conversation = logRef.current.filter(m => !m.isWelcome).map(m => `${m.user ? 'User' : 'Assistant'}: ${m.raw}`).join('\n');
    
        const formattingInstruction = `
CRITICAL FORMATTING RULE:
You MUST format your entire response using Markdown.
To ensure readability, you MUST separate all paragraphs, headings, and list items with a double line break (a blank line).

BAD EXAMPLE (never do this):
This is the first paragraph.
This is the second paragraph.

GOOD EXAMPLE (always do this):
This is the first paragraph.

This is the second paragraph.
`;

        const prompt = `${formattingInstruction}\n\nAnswer in ${lang}. Use Markdown and cite sources as "doc. Part n - Section name". CORE: ${CORE}\nDATABASE:\n${kb}\nCONVERSION:\n${conversation}\nQUESTION: """${q}"""`;

        const ans = await askGemini(prompt);
        push(ans, false, ans);
        sendLog();

    } catch (e) {
        // NEW: User-friendly error handling
        let friendlyError;
        const errorMessage = String(e.message || '');

        if (errorMessage.includes('overloaded')) {
            friendlyError = lang === 'Russian' 
                ? 'Ð¡ÐµÑ€Ð²ÐµÑ€ AI ÑÐµÐ¹Ñ‡Ð°Ñ Ð¿ÐµÑ€ÐµÐ³Ñ€ÑƒÐ¶ÐµÐ½ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ð¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾Ð¼ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð². Ð­Ñ‚Ð¾ ÐºÐ°Ðº Ñ‡Ð°Ñ Ð¿Ð¸Ðº Ð½Ð° Ð´Ð¾Ñ€Ð¾Ð³Ð°Ñ…! ðŸš— ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚Ðµ Ð²Ð°Ñˆ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ñ‡ÐµÑ€ÐµÐ· Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ.'
                : 'The AI server is currently overloaded with requests. It\'s like rush hour traffic! ðŸš— Please try your request again in a moment.';
        } else if (errorMessage.includes('TIMEOUT')) {
            friendlyError = lang === 'Russian'
                ? 'Ð’Ð°Ñˆ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð¾Ñ‡ÐµÐ½ÑŒ ÑÐ»Ð¾Ð¶Ð½Ñ‹Ð¹, Ð¸ AI Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð»Ð¾ÑÑŒ ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ Ð¼Ð½Ð¾Ð³Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð½Ð° Ñ€Ð°Ð·Ð¼Ñ‹ÑˆÐ»ÐµÐ½Ð¸Ñ. â³ ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð·Ð°Ð´Ð°Ñ‚ÑŒ Ñ‚Ð¾Ñ‚ Ð¶Ðµ Ð²Ð¾Ð¿Ñ€Ð¾Ñ ÐµÑ‰Ðµ Ñ€Ð°Ð· Ð¸Ð»Ð¸ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾ ÑƒÐ¿Ñ€Ð¾ÑÑ‚Ð¸Ñ‚Ðµ ÐµÐ³Ð¾.'
                : 'Your request is very complex and the AI took too long to think. â³ Please try asking the same question again, or try simplifying it a little.';
        } else {
            // Fallback for any other unexpected errors
            friendlyError = 'âš ï¸ ' + errorMessage;
        }
        
        push(friendlyError, false, friendlyError);
        sendLog();
    }
    setBusy(false);
}
        return React.createElement('div',{className:'flex flex-col h-screen w-full max-w-4xl mx-auto p-4 box-border'},
            ks!=='ok' && React.createElement('div',{className:'text-center text-xs text-yellow-400 mb-2'},
                ks==='loading'?'KB loadingâ€¦':'KB error (check console)'
            ),
            React.createElement('div',{className:'flex-1 overflow-y-auto space-y-4 bg-slate-800 p-4 rounded-lg'},
                log.map(m=>React.createElement('div',{key:m.id,className:`flex ${m.user?'justify-end':'justify-start'}`},
                    m.user?
                    React.createElement('div',{
                        className:`max-w-[80%] p-3 rounded-xl bg-cyan-700 text-white`,
                        style:{whiteSpace:'pre-wrap'}
                    },m.txt)
                    :
                    React.createElement('div',{
                        className:`max-w-[80%] p-3 rounded-xl bg-slate-700 ${m.isWelcome?'border border-yellow-400':''}`,
                        dangerouslySetInnerHTML:{__html:m.txt}
                    })
                )),
                busy&&React.createElement('div',{className:'text-slate-300'},"Thinkingâ€¦"),
                React.createElement('div',{ref:endRef})
            ),
            React.createElement('div',{className:'mt-3 flex gap-2'},
                React.createElement('textarea',{
                    ref:textRef,
                    className:'flex-1 resize-none bg-slate-700 text-slate-50 rounded-xl p-3 focus:outline-none',
                    rows:1,value:inp,placeholder:'Ask about WILL Geometryâ€¦',
                    onInput:e=>{setInp(e.target.value);e.target.style.height='auto';e.target.style.height=e.target.scrollHeight+'px';},
                    onKeyDown:e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send();}}
                }),
                React.createElement('button',{
                    className:'px-4 py-2 bg-cyan-600 text-white rounded-xl disabled:opacity-50',
                    disabled:!inp.trim()||busy,onClick:send
                },'Send')
            )
        );
    }
    ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
</script>
