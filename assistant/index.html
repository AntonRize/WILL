<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WILL AI Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Inter',sans-serif; background:#111827; color:#E5E7EB; }
    .msg { background:#1F2937; padding:16px 20px; border-radius:12px; line-height:1.6; margin-bottom:14px; box-shadow:0 1px 4px #0005; }
    .msg.user { background:#374151; }
    .input-row { display:flex; gap:8px; margin-top:16px; }
    .input-row input { flex:1; background:#111827; border:1px solid #374151; border-radius:8px; color:#E5E7EB; padding:10px 12px; }
    .input-row button { background:#2563EB; color:#fff; border:none; border-radius:8px; padding:10px 16px; cursor:pointer; }
  </style>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <p style="text-align:center;font-size:0.75rem;color:#9CA3AF;margin-top:1rem;">AI can make mistakes. Double-check with the main WILL documentation.</p>
  <script type="text/babel">
    const KB_FILES = [
      'WILL%20DATABASE/WILL%20PART%20I%20SR%20GR.txt',
      'WILL%20DATABASE/WILL%20PART%20II%20COSMO%20.txt',
      'WILL%20DATABASE/WILL%20PART%20III%20QM%20.txt'
    ];

    async function loadKnowledge() {
      const base = 'https://raw.githubusercontent.com/AntonRize/WILL/main/';
      const texts = await Promise.all(
        KB_FILES.map(p => fetch(base + p).then(r => r.text()))
      );
      return texts.join('\n');
    }

    function App() {
      const [messages, setMessages] = React.useState([]);
      const [input, setInput] = React.useState('');
      const [fuse, setFuse] = React.useState(null);
      const [model, setModel] = React.useState('');

      React.useEffect(() => {
        loadKnowledge().then(text => {
          const sections = text.split(/\n\s*\n/).map(t => t.trim()).filter(Boolean);
          setFuse(new Fuse(sections.map(t => ({ text: t })), { keys: ['text'], includeScore: true, threshold: 0.4 }));
        });
      }, []);

      const sendMessage = async () => {
        if (!input.trim()) return;
        const userMsg = { role: 'user', content: input };
        setMessages(prev => [...prev, userMsg]);
        setInput('');

        if (!fuse) {
          setMessages(prev => [...prev, { role: 'assistant', content: 'Knowledge base is loading, please try again shortly.' }]);
          return;
        }

        const results = fuse.search(input).slice(0, 3);
        if (results.length === 0) {
          setMessages(prev => [...prev, { role: 'assistant', content: 'I could not find an answer in the WILL documentation. Please ask your question here: https://antonrize.github.io/WILL/discussions/' }]);
          return;
        }

        const context = results.map(r => r.item.text).join('\n');
        const prompt = `${input}\n\nContext:\n${context}`;
        try {
          const res = await fetch('https://proxy-flame-seven.vercel.app/api/gemini', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt })
          });
          const text = await res.text();
          let data;
          try {
            data = JSON.parse(text);
          } catch(_) {
            throw new Error(text);
          }
          const reply = { role: 'assistant', content: data.reply || data.error };
          setMessages(prev => [...prev, reply]);
          if (data.model) setModel(data.model);
        } catch(err) {
          setMessages(prev => [...prev, { role: 'assistant', content: 'Error: ' + err.message }]);
        }
      };

      return (
        <div style={{ maxWidth: 600, margin: '0 auto', padding: '1rem' }}>
          <h1 style={{ textAlign:'center', fontSize:'1.5rem', fontWeight:'600', marginBottom:'0.5rem' }}>WILL AI Assistant</h1>
          {model && <p style={{textAlign:'center', fontSize:'0.875rem', color:'#9CA3AF'}}>Model: {model}</p>}
          <p style={{textAlign:'center', fontSize:'0.75rem', color:'#9CA3AF', marginBottom:'1rem'}}>AI can make mistakes. Double-check with the main WILL documentation.</p>
          <div style={{ minHeight: '300px', border: '1px solid #374151', padding: '1rem', marginBottom: '1rem', borderRadius: '8px' }}>
            {messages.map((m, i) => (
              <p key={i} className={`msg ${m.role}`} style={{ whiteSpace: 'pre-wrap', wordBreak: 'break-word' }}><strong>{m.role === 'user' ? 'You' : 'AI'}:</strong> {m.content}</p>
            ))}
          </div>
          <div className="input-row">
            <input
              value={input}
              onChange={e => setInput(e.target.value)}
              onKeyDown={e => e.key === 'Enter' ? sendMessage() : null}
              placeholder="Ask something..."
              style={{ width: '100%' }}
            />
            <button onClick={sendMessage}>Send</button>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
