<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-M4YFFSYJGF"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-M4YFFSYJGF');
  </script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% if page.title %}{{ page.title }} | {% endif %}{{ site.title }}</title>
  {% seo %}

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #111827;
      color: #E5E7EB;
    }
    main {
      opacity: 0;
      transition: opacity 3.0s ease-in;
    }
    #ob-tooltip {
      position: absolute;
      z-index: 10;
      max-width: 280px;
      background: rgba(17, 24, 39, 0.85);
      backdrop-filter: blur(4px);
      padding: 10px 14px;
      border: 1px solid rgba(55, 65, 81, 0.5);
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      line-height: 1.5;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease-in-out;
      text-align: left;
      white-space: pre-line;
    }
    #ouroboros-container svg {
      width: 100%;
      height: auto;
    }
  </style>
</head>

<body class="antialiased">
  {% include header.html %}

  <main class="flex flex-col items-center relative px-6 sm:px-8 py-10 sm:py-20">
    
    <div id="ouroboros-container" class="max-w-xs sm:max-w-sm md:max-w-lg lg:max-w-2xl xl:max-w-3xl">
        </div>
    <div id="ob-tooltip"></div>
    
    <nav class="mt-12 sm:mt-16 w-full max-w-4xl px-4 flex flex-wrap justify-center items-center gap-x-3 sm:gap-x-5 gap-y-2 text-xs sm:text-sm text-gray-500">
        <a href="{{ site.baseurl }}/relativistic-foundations/" class="hover:text-white transition-colors duration-300">Relativistic Foundations</a>
        <span class="text-gray-700 select-none">&bull;</span>
        <a href="{{ site.baseurl }}/WILL-AI/" class="hover:text-white transition-colors duration-300">Ask WILL AI</a>
        <span class="text-gray-700 select-none">&bull;</span>
        <a href="{{ site.baseurl }}/predictions/" class="hover:text-white transition-colors duration-300">Testable Predictions</a>
        <span class="text-gray-700 select-none">&bull;</span>
        <a href="{{ site.baseurl }}/results/" class="hover:text-white transition-colors duration-300">Results & Documents</a>
    </nav>
    
  </main>

  {{ content }} 
  
  {% include footer.html %}

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const mainElement = document.querySelector('main');
      const container = document.getElementById('ouroboros-container');
      const tooltip = document.getElementById('ob-tooltip');
      
      setTimeout(() => {
          mainElement.style.opacity = 1;
      }, 100);

      const svgUrl = '{{ site.baseurl }}/assets/OuroborosCLEAN.svg';
      
      const SEGMENT_IDS = ['path50', 'path34', 'path38', 'path42', 'path46'];
      
      const TOOLTIP_TEXT = {
        'path34': 'SPACETIME ≡ ENERGY\nUnifying Principle removing unjustified separation between “structure” and “dynamics”.',
        'path38': 'Circle and Sphere - Minimal relational carriers.\nA closed, isotropic systems with no external reference frame.',
        'path42': 'Universal Rate of Change\nThe speed of light (c) is distributed between kinetic (β) and potential (κ) components.',
        'path46': 'Topological Ratio κ²/β² = 2\nThe universal “budget” principle dictating the distribution in closed systems.',
        'path50': 'Unified Field Equation\nRₛ/r = ρ/ρₘₐₓ\nSPACETIME RATIO = ENERGY RATIO\nLinking back to the Unifying Principle.'
      };

      const SEGMENT_URLS = {
        'path34': '{{ site.baseurl }}/relativistic-foundations/#1W',
        'path38': '{{ site.baseurl }}/relativistic-foundations/#2W',
        'path42': '{{ site.baseurl }}/relativistic-foundations/#3W',
        'path46': '{{ site.baseurl }}/relativistic-foundations/#4W',
        'path50': '{{ site.baseurl }}/relativistic-foundations/#5W'
      };

      fetch(svgUrl)
        .then(response => {
          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
          return response.text();
        })
        .then(svgText => {
          container.innerHTML = svgText;
          const svg = container.querySelector('svg');
          if (!svg) {
            console.error("Critical Error: SVG element not found after injection.");
            return;
          }
          initializeAnimations(svg);
        })
        .catch(error => {
          console.error('Failed to fetch and load SVG:', error);
          container.innerHTML = `<p class="text-red-500">Error: Could not load the Ouroboros SVG.</p>`;
        });
      
      // MODIFIED: This function is now async to handle animation sequence correctly.
      async function initializeAnimations(svg) {
        const segments = SEGMENT_IDS.map(id => svg.querySelector(`#${id}`)).filter(Boolean);
        
        if (segments.length !== SEGMENT_IDS.length) {
            console.error("Failed to find all SVG segments. Check IDs:", SEGMENT_IDS);
            return;
        }

        const originalFills = new Map();
        segments.forEach(seg => {
          const computedStyle = window.getComputedStyle(seg);
          originalFills.set(seg, computedStyle.fill || '#ffffff');
        });
        
        const breathingGlow = 'drop-shadow(0 0 5px rgba(167, 243, 208, 0.7))';
        const hoverFill = '#a7f3d0';

        // --- Animation Sequence Settings ---
        const runningLightStartDelay = 3000;
        const highlightDuration = 300;
        const stepDelay = 100;
        const pauseBetweenPulses = 150;

        // This function runs a single pulse and returns a Promise
        function runSinglePulse() {
          const animations = segments.map((seg, i) => {
            return seg.animate(
              [
                { filter: 'none', fill: originalFills.get(seg) },
                { filter: breathingGlow, fill: hoverFill, offset: 0.5 },
                { filter: 'none', fill: originalFills.get(seg) }
              ],
              {
                duration: highlightDuration,
                delay: i * stepDelay,
                easing: 'ease-in-out'
              }
            );
          });
          return Promise.all(animations.map(anim => anim.finished));
        }

        // --- New, reliable animation sequence ---
        await new Promise(resolve => setTimeout(resolve, runningLightStartDelay));
        await runSinglePulse();
        await new Promise(resolve => setTimeout(resolve, pauseBetweenPulses));
        await runSinglePulse();

        // This will only start after both pulses are 100% complete
        segments.forEach(seg => {
          seg.animate(
            [{ filter: 'none' }, { filter: breathingGlow }, { filter: 'none' }],
            { duration: 5000, iterations: Infinity, easing: 'ease-in-out', delay: Math.random() * 2000 }
          );
        });
        
        // --- Event Handlers (no changes) ---
        segments.forEach(seg => {
          seg.style.cursor = 'pointer';
          seg.style.transition = 'fill 300ms ease-in-out';

          seg.addEventListener('mouseenter', () => {
            seg.setAttribute('fill', hoverFill);
            tooltip.textContent = TOOLTIP_TEXT[seg.id] || 'Info not found.';
            tooltip.style.opacity = '1';
          });

          seg.addEventListener('mousemove', (e) => {
            tooltip.style.left = (e.clientX + 20) + 'px';
            tooltip.style.top  = (e.clientY - tooltip.offsetHeight - 10) + 'px';
          });

          seg.addEventListener('mouseleave', () => {
            seg.setAttribute('fill', originalFills.get(seg));
            tooltip.style.opacity = '0';
          });

          seg.addEventListener('click', () => {
            const url = SEGMENT_URLS[seg.id];
            if (url) {
              window.location.href = url;
            }
          });
        });
      }
    });
  </script>
</body>
</html>
